<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Puter.js Bridge</title>
    <script src="https://js.puter.com/v2/"></script>
</head>
<body>
    <script>
        // Bridge functions to interact with Puter.js from native Android code
        async function puterChat(query) {
            try {
                const response = await puter.ai.chat({
                    messages: [{ role: 'user', content: query }]
                });
                return response;
            } catch (error) {
                console.error('Chat error:', error);
                throw error;
            }
        }

        async function puterChatStream(query, onChunkCallback) {
            try {
                const response = await puter.ai.chat({
                    messages: [{ role: 'user', content: query }],
                    stream: true
                });
                
                let fullText = '';
                for await (const chunk of response) {
                    if (chunk?.text) {
                        fullText += chunk.text;
                        if (onChunkCallback) {
                            onChunkCallback(chunk.text);
                        }
                    }
                }
                return fullText;
            } catch (error) {
                console.error('Chat stream error:', error);
                throw error;
            }
        }

        async function puterTxt2Img(prompt, options = {}) {
            try {
                const response = await puter.ai.txt2img(prompt, options);
                return response;
            } catch (error) {
                console.error('Txt2Img error:', error);
                throw error;
            }
        }

        async function puterImg2Txt(image) {
            try {
                // Assuming image is a base64 string or file object
                const response = await puter.ai.img2txt(image);
                return response;
            } catch (error) {
                console.error('Img2Txt error:', error);
                throw error;
            }
        }

        async function puterTxt2Speech(text, options = {}) {
            try {
                const response = await puter.ai.txt2speech(text, options);
                return response;
            } catch (error) {
                console.error('Txt2Speech error:', error);
                throw error;
            }
        }

        async function puterKvGet(key) {
            try {
                const response = await puter.kv.get(key);
                return response;
            } catch (error) {
                console.error('KV Get error:', error);
                throw error;
            }
        }

        async function puterKvSet(key, value) {
            try {
                const response = await puter.kv.set(key, value);
                return response;
            } catch (error) {
                console.error('KV Set error:', error);
                throw error;
            }
        }

        async function puterKvDel(key) {
            try {
                const response = await puter.kv.del(key);
                return response;
            } catch (error) {
                console.error('KV Del error:', error);
                throw error;
            }
        }

        async function puterKvList(pattern = '*', returnValues = false) {
            try {
                const response = await puter.kv.list(pattern, returnValues);
                return response;
            } catch (error) {
                console.error('KV List error:', error);
                throw error;
            }
        }

        async function puterKvIncr(key, amount = 1) {
            try {
                const response = await puter.kv.incr(key, amount);
                return response;
            } catch (error) {
                console.error('KV Incr error:', error);
                throw error;
            }
        }

        async function puterKvDecr(key, amount = 1) {
            try {
                const response = await puter.kv.decr(key, amount);
                return response;
            } catch (error) {
                console.error('KV Decr error:', error);
                throw error;
            }
        }

        async function puterKvFlush() {
            try {
                const response = await puter.kv.flush();
                return response;
            } catch (error) {
                console.error('KV Flush error:', error);
                throw error;
            }
        }

        // File System functions
        async function puterFsWrite(path, data, options = {}) {
            try {
                const response = await puter.fs.write(path, data, options);
                return response;
            } catch (error) {
                console.error('FS Write error:', error);
                throw error;
            }
        }

        async function puterFsRead(path, options = {}) {
            try {
                const response = await puter.fs.read(path, options);
                return response;
            } catch (error) {
                console.error('FS Read error:', error);
                throw error;
            }
        }

        async function puterFsMkdir(path, options = {}) {
            try {
                const response = await puter.fs.mkdir(path, options);
                return response;
            } catch (error) {
                console.error('FS Mkdir error:', error);
                throw error;
            }
        }

        async function puterFsReaddir(path) {
            try {
                const response = await puter.fs.readdir(path);
                return response;
            } catch (error) {
                console.error('FS Readdir error:', error);
                throw error;
            }
        }

        async function puterFsDelete(path, options = {}) {
            try {
                const response = await puter.fs.delete(path, options);
                return response;
            } catch (error) {
                console.error('FS Delete error:', error);
                throw error;
            }
        }

        async function puterFsMove(source, destination, options = {}) {
            try {
                const response = await puter.fs.move(source, destination, options);
                return response;
            } catch (error) {
                console.error('FS Move error:', error);
                throw error;
            }
        }

        async function puterFsCopy(source, destination, options = {}) {
            try {
                const response = await puter.fs.copy(source, destination, options);
                return response;
            } catch (error) {
                console.error('FS Copy error:', error);
                throw error;
            }
        }

        async function puterFsRename(path, newName) {
            try {
                const response = await puter.fs.rename(path, newName);
                return response;
            } catch (error) {
                console.error('FS Rename error:', error);
                throw error;
            }
        }

        async function puterFsStat(path) {
            try {
                const response = await puter.fs.stat(path);
                return response;
            } catch (error) {
                console.error('FS Stat error:', error);
                throw error;
            }
        }

        async function puterFsSpace() {
            try {
                const response = await puter.fs.space();
                return response;
            } catch (error) {
                console.error('FS Space error:', error);
                throw error;
            }
        }

        // Authentication functions
        async function puterAuthSignIn() {
            try {
                // This will trigger the authentication flow which will be intercepted by the Android WebView
                // The actual authentication will happen in Chrome Custom Tabs
                console.log("Triggering Puter authentication...");
                
                // Trigger the authentication flow directly - the Android WebView will intercept this
                // We return a success indicator since the actual completion happens via handleAuthCallback
                const result = await puter.auth.signIn();
                console.log("Sign in initiated successfully", result);
                
                // Return a success indicator - the actual completion will happen via handleAuthCallback
                return { status: "auth_started", message: "Authentication flow initiated" };
            } catch (error) {
                console.error('Auth Sign In error:', error);
                throw error;
            }
        }

        async function puterAuthSignOut() {
            try {
                const response = await puter.auth.signOut();
                return response;
            } catch (error) {
                console.error('Auth Sign Out error:', error);
                throw error;
            }
        }

        function puterAuthIsSignedIn() {
            try {
                return puter.auth.isSignedIn();
            } catch (error) {
                console.error('Auth Check error:', error);
                return false;
            }
        }

        async function puterAuthGetUser() {
            try {
                const response = await puter.auth.getUser();
                return response;
            } catch (error) {
                console.error('Get User error:', error);
                throw error;
            }
        }
        
        // Function to handle authentication callback from Android
        function handleAuthCallback(token) {
            console.log("Handling auth callback with token:", token);
            // This function will be called when the Android app receives the auth token
            // We can use this to complete the authentication in the Puter.js context
            if (token) {
                // Puter.js should automatically handle the authentication completion
                // when the redirect comes back with the token
                console.log("Auth callback handled, token received:", token);
                
                // Notify Android that authentication is complete
                if (window.AndroidInterface) {
                    window.AndroidInterface.onAuthSuccess(JSON.stringify({token: token, status: "authenticated"}));
                }
            } else {
                console.error("Unable to handle auth callback - no token provided");
            }
        }

        // Handle responses back to Android
        function handleResponse(response, callbackId) {
            if (window.AndroidInterface) {
                window.AndroidInterface.onAIResponse(JSON.stringify(response), callbackId);
            }
        }

        function handleError(error, callbackId) {
            if (window.AndroidInterface) {
                window.AndroidInterface.onAIError(error.message, callbackId);
            }
        }

        // Ready indicator
        window.puterBridgeReady = true;
        
        console.log("Puter.js bridge ready");
    </script>
</body>
</html>